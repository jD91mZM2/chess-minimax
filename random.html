<!DOCTYPE html>
<html>
	<head>
		<title>Chess</title>
		<link rel="stylesheet" type="text/css" href="css/chessboard-0.3.0.min.css" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<style>
			body {
				text-align: center;
			}
			#board {
				position: absolute;
				top: calc(50% - 200px);
				left: calc(50% - 200px);
			}
			#board .highlight {
				background: yellow;
				transition: background 1s;
			}
		</style>
	</head>
	<body>
		<h3>Crappy chess minimax</h3>
		<p><i>
			Done possible thanks to
			<a href="https://chessboardjs.com/">chessboard.js</a>
			and
			<a href="https://github.com/jhlywa/chess.js/">chess.js</a>
		</i></p>

		<div id="board" style="width: 400px"></div>

		<script src="js/jquery-3.2.1.min.js"></script>
		<script src="js/chessboard-0.3.0.min.js"></script>
		<script src="js/chess.min.js"></script>
		<script>
			var server = location.hash.replace(/^#/, "");
			if (server === "") {
				server = prompt("Server?", "localhost");
				history.pushState(null, null, "#" + server);
			}
			var socket = new WebSocket("ws://" + server + ":27455/", "chess");
			function send(message) {
				console.log("SEND: " + message);
				socket.send(message);
			}

			socket.onopen = function(event) {
				send("INIT v2");
			}
			socket.onclose = function(event) {
				location.reload();
			}

			var board, game;
			function init() {
				board = ChessBoard("board", "start");
				game  = new Chess();
			}

			function move() {
				setTimeout(function() {
					var moves = game.moves({ verbose: true });
					var move  = moves[Math.floor(Math.random() * moves.length)];
					send("MOVE " + move.from.toUpperCase() + " " + move.to.toUpperCase())
					game.move(move);
					board.position(game.fen());
				}, 100);
			}

			function command(args) {
				$(".highlight").removeClass("highlight");

				var cmd = args.shift();
				switch (cmd) {
				case "ACCEPT":
					break;
				case "REFUSE":
					alert("Impossible!");
					break;
				case "BLACK":
					init();
					move();
					break;
				case "WHITE":
					init();
					board.flip();
					command(args);
					break;
				case "MOVE":
					var from = args[0].toLowerCase();
					var to   = args[1].toLowerCase();
					board.move(from + '-' + to);
					game.move({
						from: from,
						to: to,
						promotion: 'q',
					});

					move();
					break;
				case "HIGHLIGHT":
					$(".square-" + args[0].toLowerCase()).addClass("highlight");
					break;
				case "DIFF":
					// TODO!
					// See https://github.com/oakmac/chessboardjs/issues/147.
					break;
				case "CHECKMATE":
					location.reload();
					break;
				case "I-GIVE-UP":
					location.reload();
					break;
				}
			}

			socket.onmessage = function(event) {
				console.log("RECEIVED: " + event.data);
				var args = event.data.split(" ");
				command(args);
			}
		</script>
	</body>
</html>
