<!DOCTYPE html>
<html>
	<head>
		<title>Chess</title>
		<link rel="stylesheet" type="text/css" href="css/chessboard-0.3.0.min.css" />
		<style>
			body {
				text-align: center;
			}
			#board {
				position: absolute;
				top: calc(50% - 200px);
				left: calc(50% - 200px);
			}
			#board .highlight {
				background: yellow;
				transition: background 1s;
			}
		</style>
	</head>
	<body>
		Crappy chess minimax
		<div id="board" style="width: 400px"></div>

		<script src="js/jquery-3.2.1.min.js"></script>
		<script src="js/chessboard-0.3.0.min.js"></script>
		<script>
			var white = true;
			function decode(pos) {
				if (white) {
					return ["h".charCodeAt(0) - pos.charCodeAt(0), pos.charCodeAt(1) - "1".charCodeAt(0)];
				} else {
					return [pos.charCodeAt(0) - "a".charCodeAt(0), "8".charCodeAt(0) - pos.charCodeAt(1)];
				}
			}
			function encode(pos) {
				if (white) {
					return String.fromCharCode((7 - parseInt(pos[0])) + "a".charCodeAt(0), "1".charCodeAt(0) + parseInt(pos[1]));
				} else {
					return String.fromCharCode("a".charCodeAt(0) + parseInt(pos[0]), (7 - parseInt(pos[1])) + "1".charCodeAt(0));
				}
			}
			var socket = new WebSocket("ws://localhost:1234", "chess");
			socket.onopen = function (event) {
				socket.send("INIT v0");
			}

			var undo;

			var board;
			function init() {
				board = ChessBoard("board", {
					position: "start",
					draggable: true,
					onDrop: function(source, target, piece, newPos, oldPos, orientation) {
						if (waiting) {
							return 'snapback';
						}

						waiting = true;
						undo = oldPos;
						source = decode(source);
						target = decode(target);
						socket.send("MOVE " + source[0] + " " + source[1] + " " + target[0] + " " + target[1]);
					},
				});
			}

			var waiting = false;

			function command(args) {
				$(".highlight").removeClass("highlight");

				var cmd = args.shift();
				switch (cmd) {
				case "ACCEPT":
					break;
				case "REFUSE":
					board.position(undo);
					waiting = false;
					break;
				case "BLACK":
					init();
					break;
				case "WHITE":
					init();
					board.flip();
					command(args);
					break;
				case "MOVE":
					board.move(encode(args.slice(0, 2)) + "-" + encode(args.slice(2, 4)));
					waiting = false;
					break;
				case "HIGHLIGHT":
					$(".square-" + encode(args)).addClass("highlight");
					break;
				case "INTO-QUEEN":
					// TODO!
					break;
				}
			}

			socket.onmessage = function (event) {
				console.log(event.data);
				var args = event.data.split(" ");
				command(args);
			}
		</script>
	</body>
</html>
