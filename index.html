<!DOCTYPE html>
<html>
	<head>
		<title>Chess</title>
		<link rel="stylesheet" type="text/css" href="css/chessboard-0.3.0.min.css" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<style>
			body {
				text-align: center;
			}
			#board {
				position: absolute;
				top: calc(50% - 200px);
				left: calc(50% - 200px);
			}
			#board .highlight {
				background: yellow;
				transition: background 1s;
			}
		</style>
	</head>
	<body>
		<h3>Crappy chess minimax</h3>
		<p>Done possible thanks to <i><a href="https://chessboardjs.com/">chessboard.js</a></i></p>

		<div id="board" style="width: 400px"></div>

		<script src="js/jquery-3.2.1.min.js"></script>
		<script src="js/chessboard-0.3.0.min.js"></script>
		<script>
			var server = prompt("Server?", "localhost")
			var socket = new WebSocket("ws://" + server + ":27455/", "chess");
			function send(message) {
				console.log("SEND: " + message);
				socket.send(message);
			}

			var is_closed = false;
			socket.onopen = function(event) {
				send("INIT v1");
			}
			socket.onclose = function(event) {
				is_closed = true;
				setTimeout(function() {
					alert("Connection dropped.");
				}, 3000);
			}

			var undo;

			var board;
			function init() {
				board = ChessBoard("board", {
					position: "start",
					draggable: true,
					onDragStart: function(source, piece, position, orientation) {
						return !is_closed;
					},
					onDrop: function(source, target, piece, newPos, oldPos, orientation) {
						if (waiting) {
							return 'snapback';
						}

						waiting = true;
						undo = oldPos;
						send("MOVE " + source.toUpperCase() + " " + target.toUpperCase());
					},
				});
			}

			var waiting = false;

			function command(args) {
				$(".highlight").removeClass("highlight");

				var cmd = args.shift();
				switch (cmd) {
				case "ACCEPT":
					break;
				case "REFUSE":
					board.position(undo);
					waiting = false;
					break;
				case "BLACK":
					init();
					break;
				case "WHITE":
					init();
					board.flip();
					command(args);
					break;
				case "MOVE":
					board.move(args[0].toLowerCase() + "-" + args[1].toLowerCase());
					waiting = false;
					break;
				case "HIGHLIGHT":
					$(".square-" + args[0].toLowerCase()).addClass("highlight");
					break;
				case "INTO-QUEEN":
					// TODO!
					// See https://github.com/oakmac/chessboardjs/issues/147.
					break;
				case "CHECKMATE":
					setTimeout(function() {
						alert("Checkmate, " + args[0].toLowerCase());
					}, 1000);
					break;
				case "I-GIVE-UP":
					alert("Are you playing this against another minimax bot, or are you just really skilled?\n\n" +
							"Because the bot gave up.");
				}
			}

			socket.onmessage = function(event) {
				console.log("RECEIVED: " + event.data);
				var args = event.data.split(" ");
				command(args);
			}
		</script>
	</body>
</html>
