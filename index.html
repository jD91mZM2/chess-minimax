<!DOCTYPE html>
<html>
	<head>
		<title>Chess</title>
		<link rel="stylesheet" type="text/css" href="css/chessboard-0.3.0.min.css" />
		<style>
			body {
				text-align: center;
			}
			#board {
				position: absolute;
				top: calc(50% - 200px);
				left: calc(50% - 200px);
			}
			#board .highlight {
				background: yellow;
				transition: background 1s;
			}
		</style>
	</head>
	<body>
		Crappy chess minimax
		<div id="board" style="width: 400px"></div>

		<script src="js/jquery-3.2.1.min.js"></script>
		<script src="js/chessboard-0.3.0.min.js"></script>
		<script>
			var socket = new WebSocket("ws://localhost:1234", "chess");
			socket.onopen = function (event) {
				socket.send("INIT v0");
			}

			var undo;

			var board;
			function init() {
				board = ChessBoard("board", {
					position: "start",
					draggable: true,
					onDrop: function(source, target, piece, newPos, oldPos, orientation) {
						if (waiting) {
							return 'snapback';
						}

						waiting = true;
						undo = oldPos;
						socket.send("MOVE " + source.toUpperCase() + " " + target.toUpperCase());
					},
				});
			}

			var waiting = false;

			function command(args) {
				$(".highlight").removeClass("highlight");

				var cmd = args.shift();
				switch (cmd) {
				case "ACCEPT":
					break;
				case "REFUSE":
					board.position(undo);
					waiting = false;
					break;
				case "BLACK":
					init();
					break;
				case "WHITE":
					init();
					board.flip();
					command(args);
					break;
				case "MOVE":
					board.move(args[0].toLowerCase() + "-" + args[1].toLowerCase());
					waiting = false;
					break;
				case "HIGHLIGHT":
					$(".square-" + args[0].toLowerCase()).addClass("highlight");
					break;
				case "INTO-QUEEN":
					// TODO!
					break;
				}
			}

			socket.onmessage = function (event) {
				var args = event.data.split(" ");
				command(args);
			}
		</script>
	</body>
</html>
